name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'apps/web/**'
      - 'libs/**'
      - 'infra/**'
      - 'prisma/**'
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: 'Deploy infrastructure changes'
        type: boolean
        default: false
      deploy_api:
        description: 'Deploy API'
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy Web'
        type: boolean
        default: true

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: tend-api
  ECS_CLUSTER: tend-cluster
  ECS_SERVICE: tend-api-service

jobs:
  # Deploy infrastructure if changed or manually triggered
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_infra == 'true' ||
      github.event_name == 'push' && contains(github.event.head_commit.modified, 'infra/')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install CDK dependencies
        run: |
          cd infra
          npm ci

      - name: CDK Diff
        run: |
          cd infra
          npx cdk diff --all

      - name: CDK Deploy
        run: |
          cd infra
          npx cdk deploy --all --require-approval never

  # Build and deploy API
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_api == 'true' ||
      github.event_name == 'push'
    needs: [deploy-infrastructure]
    # Run even if infrastructure deploy was skipped
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build API
        run: npx nx build api --configuration=production

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f apps/api/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE

  # Build and deploy Web
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_web == 'true' ||
      github.event_name == 'push'
    needs: [deploy-api]
    # Run even if API deploy was skipped
    if: always() && (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Web
        run: npx nx build web --configuration=production
        env:
          API_URL: ${{ secrets.API_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync dist/apps/web s3://${{ secrets.WEB_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          # Upload index.html and JSON files with no-cache
          aws s3 cp dist/apps/web/index.html s3://${{ secrets.WEB_BUCKET_NAME }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

          aws s3 sync dist/apps/web s3://${{ secrets.WEB_BUCKET_NAME }} \
            --exclude "*" \
            --include "*.json" \
            --cache-control "no-cache"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/index.html" "/*.json"

  # Run database migrations
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-api]
    if: |
      github.event_name == 'push' &&
      contains(github.event.head_commit.modified, 'prisma/')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get database URL from Secrets Manager
        id: get-secret
        run: |
          SECRET=$(aws secretsmanager get-secret-value --secret-id tend/database/credentials --query SecretString --output text)
          echo "::add-mask::$SECRET"
          echo "DATABASE_URL=$(echo $SECRET | jq -r '.connectionString')" >> $GITHUB_ENV

      - name: Run migrations
        run: npx prisma migrate deploy
